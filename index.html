<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Magna - Dashboard de Engenharia</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  /* :::::::: VARI√ÅVEIS :::::::: */
  :root {
    --header-bg: #1c2e4a;
    --bg-color: #f4f6f8;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --card-glass: rgba(255, 255, 255, 0.9);
    --card-border: rgba(255, 255, 255, 1);
    --primary-blue: #0078D7;
    --danger-color: #ef4444;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --modal-bg: #ffffff;
    --menu-shadow: 0 10px 25px rgba(0,0,0,0.15);
  }

  body.dark-mode {
    --header-bg: #0f172a;
    --bg-color: #0f172a;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --card-glass: rgba(30, 41, 59, 0.9);
    --card-border: rgba(255, 255, 255, 0.1);
    --modal-bg: #1e293b;
    --menu-shadow: 0 10px 25px rgba(0,0,0,0.5);
  }

  * { box-sizing: border-box; outline: none; }

  body { 
      font-family: 'Inter', sans-serif; margin: 0; height: 100vh; overflow: hidden; 
      background-color: var(--bg-color); color: var(--text-primary); 
      transition: background 0.3s, color 0.3s;
  }

  /* :::::::: LOGIN REFINADO (GLASSMORPISM) :::::::: */
  body:not(.logged-in) {
      background: radial-gradient(circle at 30% 50%, #1c2e4a 0%, #05080a 100%);
      display: flex; align-items: center; justify-content: center;
  }
  #login-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 2000; }
  
  .car-scene { position: absolute; top: 0; right: 0; bottom: 0; width: 75%; z-index: 1; }
  .full-scene-img { 
      width: 100%; height: 100%; object-fit: cover; object-position: center; 
      -webkit-mask-image: linear-gradient(to right, transparent 5%, black 45%); 
      mask-image: linear-gradient(to right, transparent 5%, black 45%); 
  }

  .login-card-container { 
      width: 40%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 10; 
      background: linear-gradient(to right, rgba(0,0,0,0.8) 0%, transparent 100%); 
      padding-left: 5%;
  }

  #auth-container { 
      background: rgba(255, 255, 255, 0.07); 
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 60px 45px; 
      border-radius: 28px; 
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6); 
      width: 100%;
      max-width: 420px; 
      text-align: center; 
      animation: fadeInLogin 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes fadeInLogin { 
      from { opacity: 0; transform: translateY(30px); } 
      to { opacity: 1; transform: translateY(0); } 
  }

  .auth-header h2 { color: white; font-size: 1.8rem; margin: 0 0 8px 0; font-weight: 700; }
  .auth-header p { color: #94a3b8; font-size: 0.95rem; margin-bottom: 35px; }

  .auth-input { 
      width: 100%; padding: 16px 20px; margin-bottom: 18px; 
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1); 
      border-radius: 12px; 
      font-family: inherit; font-size: 1rem; 
      color: white;
      transition: all 0.3s;
  }
  .auth-input::placeholder { color: #64748b; }
  .auth-input:focus { 
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 4px rgba(0, 120, 215, 0.2);
  }
  /* ESTILO NOVO: CHECKBOX LEMBRAR-ME */
  .remember-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      color: #94a3b8;
      font-size: 0.85rem;
      text-align: left;
      padding-left: 5px;
  }
  .remember-container input { cursor: pointer; accent-color: var(--primary-blue); width: 16px; height: 16px; }
  .remember-container label { cursor: pointer; user-select: none; }

  .auth-btn { 
      background: linear-gradient(135deg, #0078D7 0%, #005a9e 100%);
      color: white; padding: 16px; border: none; border-radius: 12px; width: 100%; 
      cursor: pointer; font-weight: 700; font-size: 1.1rem; margin-top: 10px; 
      transition: all 0.3s;
      box-shadow: 0 10px 20px rgba(0, 120, 215, 0.3);
      letter-spacing: 1px;
  }
  .auth-btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 15px 25px rgba(0, 120, 215, 0.4);
  }
  
  .auth-actions { display: flex; justify-content: space-between; margin-top: 25px; font-size: 0.85rem; }
  .auth-link { color: #94a3b8; text-decoration: none; cursor: pointer; font-weight: 500; transition: color 0.2s; }
  .auth-link:hover { color: white; }

  .hidden-screen { display: none !important; }
  body.logged-in #login-wrapper { display: none; }

  /* :::::::: TOAST NOTIFICATION :::::::: */
  #toast-container {
      position: fixed; top: 20px; right: 20px; z-index: 10000;
      display: flex; flex-direction: column; gap: 10px; pointer-events: none;
  }
  .toast {
      background-color: var(--primary-blue); color: white; padding: 15px 20px;
      border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: flex; align-items: center; gap: 15px; min-width: 320px;
      animation: slideInToast 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      pointer-events: auto; border-left: 6px solid rgba(0,0,0,0.15);
  }
  .toast.success { background-color: var(--success-color); }
  .toast.warning { background-color: var(--warning-color); }
  .toast.error { background-color: var(--danger-color); }

  .toast-icon { font-size: 1.4rem; }
  .toast-content { display: flex; flex-direction: column; }
  .toast-title { font-size: 0.75rem; font-weight: 800; opacity: 0.9; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px; }
  .toast-msg { font-size: 0.9rem; font-weight: 500; line-height: 1.3; }
  .toast.hiding { opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; }
  @keyframes slideInToast { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }

  /* DASHBOARD LAYOUT */
  #main-app { display: none; flex-direction: column; height: 100%; width: 100%; }
  
  header {
      height: 70px; background-color: var(--header-bg); display: flex; align-items: center; 
      justify-content: space-between; padding: 0 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.25); 
      z-index: 100; color: white; position: relative; 
  }

  .header-logo img { height: 45px; width: auto; display: block; }

  .header-brand { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-align: center; }
  .header-brand h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; }
  .header-brand h2 { margin: 0; font-size: 0.7rem; color: #94a3b8; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }
  
  .header-controls { display: flex; align-items: center; gap: 20px; }

  .project-select-wrapper { position: relative; }
  #projectButton { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; min-width: 200px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
  #projectDropdown { position: absolute; top: 110%; left: 0; width: 100%; background: var(--modal-bg); border-radius: 6px; box-shadow: var(--menu-shadow); display: none; z-index: 200; overflow: hidden; }
  #projectDropdown.show { display: block; }
  #projectDropdown button { width: 100%; padding: 10px; text-align: left; background: none; border: none; cursor: pointer; color: var(--text-primary); border-bottom: 1px solid #eee; }
  #projectDropdown button:hover { background: rgba(0,0,0,0.05); }
  .btn-all-projects { font-weight: bold; color: var(--primary-blue) !important; background-color: rgba(0,120,215,0.05) !important; }

  .user-profile { display: flex; align-items: center; gap: 12px; font-size: 0.9rem; font-weight: 500; position: relative; }
  .avatar-circle { width: 34px; height: 34px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
  .menu-toggle-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
  .main-menu-dropdown { position: absolute; top: 130%; right: 0; width: 220px; background: var(--modal-bg); border-radius: 8px; box-shadow: var(--menu-shadow); display: none; flex-direction: column; padding: 5px 0; z-index: 300; border: 1px solid var(--card-border); }
  .main-menu-dropdown.show { display: flex; }
  .menu-item { background: none; border: none; padding: 12px 20px; text-align: left; cursor: pointer; color: var(--text-primary); display: flex; align-items: center; gap: 10px; font-size: 0.9rem; transition: background 0.2s; }
  .menu-item:hover { background: rgba(0,0,0,0.05); }
  .menu-item.danger { color: var(--danger-color); border-top: 1px solid #eee; }

  #dashboard-body { flex: 1; display: flex; position: relative; overflow: hidden; background-image: linear-gradient(rgba(100, 116, 139, 0.15) 1px, transparent 1px), linear-gradient(90deg, rgba(100, 116, 139, 0.15) 1px, transparent 1px); background-size: 40px 40px; }
  .dashboard-grid { display: grid; grid-template-columns: 350px 1fr; width: 100%; height: 100%; max-width: 1600px; margin: 0 auto; z-index: 2; }

  /* CARD VIS√ÉO GERAL */
  .indicators-column { display: flex; align-items: center; justify-content: center; padding: 20px; transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.6s; z-index: 5; }
  body.view-active .indicators-column { transform: translateX(-60px); opacity: 1; }
  .overview-card { width: 100%; background: var(--card-glass); backdrop-filter: blur(12px); border: 1px solid var(--card-border); border-radius: 24px; padding: 30px; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 24px; }
  .card-header h3 { margin: 0; font-size: 1.1rem; color: var(--text-primary); font-weight: 700; transition: color 0.3s; }
  .widget-progress { display: flex; align-items: center; justify-content: center; flex-direction: column; background: rgba(255,255,255,0.5); padding: 20px; border-radius: 16px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); position: relative; }
  body.dark-mode .widget-progress { background: rgba(255,255,255,0.05); }
  .progress-label-top { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px; width: 100%; text-align: left; }
  .donut-chart-container { position: relative; width: 160px; height: 160px; display: flex; align-items: center; justify-content: center; }
  .donut-chart { width: 100%; height: 100%; } 
  .donut-bg { fill: none; stroke: #e2e8f0; stroke-width: 2.5; } body.dark-mode .donut-bg { stroke: #334155; }
  .donut-fill { fill: none; stroke: var(--primary-blue); stroke-width: 2.5; stroke-dasharray: 0, 100; stroke-linecap: round; transition: stroke-dasharray 1s ease, stroke 0.3s; }
  .chart-text-group { position: absolute; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .chart-percent { font-size: 2.2rem; font-weight: 800; color: var(--text-primary); line-height: 1; }
  .widget-small { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.4); }
  body.dark-mode .widget-small { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
  .widget-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .icon-danger { background: #fee2e2; color: var(--danger-color); } body.dark-mode .icon-danger { background: rgba(239,68,68,0.2); }
  .icon-calendar { background: #e0f2fe; color: var(--primary-blue); } body.dark-mode .icon-calendar { background: rgba(59,130,246,0.2); }
  .widget-text h4 { margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; } .widget-text p { margin: 2px 0 0 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }

  .gear-column { display: flex; align-items: center; justify-content: center; padding: 20px; transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
  body.view-active .gear-column { transform: translateX(-140px) scale(0.95); }
  svg#gearSVG { width: 550px; height: 550px; filter: drop-shadow(0 30px 40px rgba(0,0,0,0.4)); }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .gear-spin { transform-origin: 250px 250px; animation: spin 20s linear infinite; }
  .gear-spin:hover { animation-play-state: paused; }
  .gear-spin.paused { animation-play-state: paused; }
  .sector-piece { transition: filter 0.3s, transform 0.2s; cursor: pointer; }
  .sector-piece:hover { filter: brightness(1.2) drop-shadow(0 0 10px rgba(255,255,255,0.5)); transform: scale(1.02); z-index: 10; }
  .sector-selected { transform: scale(1.05) !important; filter: brightness(1.1) drop-shadow(0 0 15px rgba(255,255,255,0.8)) !important; }

  /* MODAL LATERAL */
  #details-modal { position: fixed; right: -450px; top: 70px; bottom: 0; width: 420px; background: var(--modal-bg); box-shadow: -10px 0 30px rgba(0,0,0,0.1); z-index: 500; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; border-left: 1px solid #e2e8f0; }
  #details-modal.open { right: 0; }
  .modal-header { padding: 20px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: flex-start; }
  .sector-responsible { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; font-weight: 500; }
  .modal-content { flex: 1; padding: 20px; overflow-y: auto; overflow-x: hidden; }
  
  @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
  }

  .task-item { 
      background: var(--bg-color); border: 1px solid rgba(0,0,0,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; gap: 10px; align-items: center; transition: transform 0.2s, box-shadow 0.2s, background 0.2s; 
      opacity: 0;
      animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
  .task-item:hover { transform: translateX(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: #ffffff; }
  .task-status-bar { width: 4px; border-radius: 2px; align-self: stretch; }
  .task-info { flex: 1; }
  .task-title { font-weight: 600; font-size: 0.95rem; display: block; color: var(--text-primary); text-decoration: none; }
  .task-title-link { color: var(--primary-blue); cursor: pointer; transition: color 0.2s; text-decoration: none; }
  .task-title-link:hover { text-decoration: underline; color: #0056b3; }
  .task-meta { font-size: 0.8rem; color: var(--text-secondary); display: flex; gap: 10px; margin-top: 4px; align-items: center; }
  .btn-icon-edit { background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 1.1rem; padding: 5px; transition: color 0.2s; }
  .btn-icon-edit:hover { color: var(--primary-blue); background: rgba(0,0,0,0.05); border-radius: 4px; }
  
  .task-edit-card { background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); animation: fadeIn 0.2s; }
  .edit-row { display: flex; gap: 10px; }
  .edit-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-family: inherit; font-size: 0.9rem; }
  .edit-input.full { flex: 1; }
  .edit-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 5px; padding-top: 10px; border-top: 1px solid #e2e8f0; }
  .btn-action { padding: 6px 12px; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; font-size: 0.85rem; transition: opacity 0.2s; }
  .btn-action:hover { opacity: 0.8; }
  .btn-save { background: var(--success-color); color: white; }
  .btn-cancel { background: #94a3b8; color: white; }
  .btn-delete { background: var(--danger-color); color: white; }
  .add-task-container { padding: 15px; border-top: 1px solid #e2e8f0; background: var(--modal-bg); }
  .btn-show-add { width: 100%; padding: 12px; background: #f1f5f9; border: 2px dashed #cbd5e1; color: #64748b; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
  .btn-show-add:hover { background: #e2e8f0; border-color: #94a3b8; color: #475569; }
  #add-task-form { display: none; flex-direction: column; gap: 10px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; animation: slideUp 0.3s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  #history-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .history-box { width: 500px; max-width: 90%; background: var(--modal-bg); border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 80vh; }
  .history-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  .history-list { padding: 20px; overflow-y: auto; flex: 1; }
  .hist-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; color: var(--text-primary); }
  .hist-time { font-size: 0.75rem; color: var(--text-secondary); display: block; margin-top: 2px; }
  .empty-hist { text-align: center; color: var(--text-secondary); padding: 20px; }
  .gear-tooltip { position: fixed; background: rgba(15, 23, 42, 0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; pointer-events: none; z-index: 1000; display: none; }
  
  #powerbi-overlay, #excel-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #f4f6f8; z-index: 3000; display: none; 
      flex-direction: column;
  }
  .external-modal-header {
      height: 60px; background: var(--header-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; color: white;
  }
  .external-modal-content {
      flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  iframe.external-frame {
      width: 100%; height: 100%; border: none; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  @media (max-width: 1000px) {
      .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      #details-modal { width: 100%; }
      svg#gearSVG { width: 350px; height: 350px; }
      .car-scene { display: none; }
      .login-card-container { width: 100%; padding-left: 0; }
  }
</style>
</head>
<body>

<div id="gear-tooltip" class="gear-tooltip"></div>
<div id="toast-container"></div> 

<div id="history-overlay">
    <div class="history-box">
        <div class="history-header">
            <h3 style="margin:0; color:var(--text-primary)">Hist√≥rico de Atualiza√ß√µes</h3>
            <button onclick="toggleHistory()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;color:var(--text-primary)">&times;</button>
        </div>
        <div id="history-content" class="history-list"></div>
        <div style="padding:15px; border-top:1px solid #eee; text-align:right;">
             <button onclick="clearHistory()" style="color:var(--danger-color); background:none; border:none; cursor:pointer;">Limpar Hist√≥rico</button>
        </div>
    </div>
</div>

<div id="powerbi-overlay">
    <div class="external-modal-header">
        <h3 style="margin:0">Dashboard Setorial (Power BI)</h3>
        <button onclick="togglePowerBI()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;color:white">&times;</button>
    </div>
    <div class="external-modal-content">
        <iframe id="pbi-iframe" class="external-frame" src="" allowFullScreen="true"></iframe>
    </div>
</div>

<div id="excel-overlay">
    <div class="external-modal-header">
        <h3 style="margin:0">Matriz de Habilidades (Excel)</h3>
        <button onclick="toggleExcel()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;color:white">&times;</button>
    </div>
    <div class="external-modal-content">
        <iframe id="excel-iframe" class="external-frame" src=""></iframe>
    </div>
</div>

<!-- TELA DE LOGIN ATUALIZADA -->
<div id="login-wrapper">
    <div class="login-card-container">
        <div id="auth-container">
            <!-- LOGO INTEGRADA -->
            <div style="margin-bottom: 30px; display: flex; justify-content: center;">
                <img src="images/logo.png" alt="Logo Magna" style="height: 50px; width: auto; filter: brightness(0) invert(1);" onerror="this.style.display='none'">
            </div>

            <div class="auth-header">
                <h2>Bem-vindo</h2>
            </div>
            
            <!-- TELA LOGIN -->
            <div id="screen-login" class="auth-form">
                <input type="text" id="login-user" class="auth-input" placeholder="Usu√°rio">
                <input type="password" id="login-pass" class="auth-input" placeholder="Senha">
                <div class="remember-container">
    <input type="checkbox" id="remember-me">
    <label for="remember-me">Lembrar minhas credenciais</label>
</div>
                <button onclick="login()" class="auth-btn">ENTRAR</button>
                <div class="auth-actions">
                    <a class="auth-link" onclick="showScreen('register')">Criar conta</a>
                    <a class="auth-link" onclick="showScreen('forgot')">Esqueci a senha</a>
                </div>
            </div>
            
            <!-- TELA CADASTRO -->
            <div id="screen-register" class="auth-form hidden-screen">
                <h3 style="color: white; margin-bottom:15px;">Criar Conta</h3>
                <input type="text" id="reg-user" class="auth-input" placeholder="Nome Completo">
                <input type="email" id="reg-email" class="auth-input" placeholder="Email">
                <input type="password" id="reg-pass" class="auth-input" placeholder="Senha">
                <button onclick="showToast('Cadastro realizado com sucesso!'); showScreen('login')" class="auth-btn">CADASTRAR</button>
                <div class="auth-actions" style="justify-content: center;">
                    <a class="auth-link" onclick="showScreen('login')">Voltar ao Login</a>
                </div>
            </div>

            <!-- TELA ESQUECI SENHA -->
            <div id="screen-forgot" class="auth-form hidden-screen">
                <h3 style="color: white; margin-bottom:15px;">Redefinir Senha</h3>
                <input type="text" id="forgot-user" class="auth-input" placeholder="Nome de usu√°rio">
                <input type="password" id="forgot-new-pass" class="auth-input" placeholder="Nova senha">
                <input type="password" id="forgot-confirm-pass" class="auth-input" placeholder="Confirmar nova senha">
                <button onclick="resetPassword()" class="auth-btn">CONFIRMAR E ALTERAR</button>
                <div class="auth-actions" style="justify-content: center;">
                    <a class="auth-link" onclick="showScreen('login')">Cancelar</a>
                </div>
            </div>
        </div>
    </div>
    <div class="car-scene">
        <img src="./images/carro.jpg" class="full-scene-img" alt="Carro" onerror="this.style.display='none'">
    </div>
</div>

<div id="main-app">
    <header>
        <div class="header-logo">
             <img src="images/logo.png" alt="Logo Magna" onerror="this.style.display='none'">
        </div>
        <div class="header-brand">
            <h1>Gerenciamento de Projetos</h1>
            <h2>ENG. DE PROCESSOS</h2>
        </div>
        <div class="header-controls">
            <div class="project-select-wrapper">
                <button id="projectButton"><span id="currentProjectText">Todos</span> <span>‚ñº</span></button>
                <div id="projectDropdown"></div>
            </div>
            <div class="user-profile">
                <span id="welcome-msg">Ol√°, Usu√°rio</span>
                <div class="avatar-circle">RA</div>
                <button class="menu-toggle-btn" onclick="toggleMainMenu()">‚ò∞</button>
                <div id="main-menu" class="main-menu-dropdown">
                    <button class="menu-item" onclick="toggleExcel()"><span>üìã</span> Matriz Habilidades</button>
                    <button class="menu-item" onclick="togglePowerBI()"><span>üìä</span> Atividades Engenharia</button>
                    <button class="menu-item" onclick="toggleDarkMode()"><span>üåô</span> Modo Escuro</button>
                    <button class="menu-item" onclick="toggleHistory()"><span>üìú</span> Ver Hist√≥rico</button>
                    <button class="menu-item danger" onclick="logout()"><span>üö™</span> Sair</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dashboard-body">
        <div class="dashboard-grid">
            <div class="indicators-column">
                <div class="overview-card">
                    <div class="card-header"><h3>Vis√£o Geral do Projeto</h3></div>
                    <div class="widget-progress">
                        <div class="progress-label-top">Progresso</div>
                        <div class="donut-chart-container">
                            <svg class="donut-chart" viewBox="0 0 36 36">
                                <path class="donut-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                                <path id="donut-fill" class="donut-fill" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                            </svg>
                            <div class="chart-text-group">
                                <span id="card-total-percent" class="chart-percent">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="widget-small">
                        <div class="widget-icon icon-danger">‚ö†Ô∏è</div>
                        <div class="widget-text"><h4>Tarefas Cr√≠ticas</h4><p id="card-critical-count" style="color:var(--danger-color)">0</p></div>
                    </div>
                    <div class="widget-small">
                        <div class="widget-icon icon-calendar">üìÖ</div>
                        <div class="widget-text"><h4>Pr√≥x. Entrega</h4><p id="card-next-date">--/--</p></div>
                    </div>
                </div>
            </div>
            <div class="gear-column"><svg viewBox="0 0 500 500" id="gearSVG"></svg></div>
        </div>
    </div>

    <div id="details-modal">
        <div class="modal-header">
            <div style="display:flex; flex-direction:column;">
                <h2 id="modal-sector-title" style="margin:0;">Detalhes</h2>
                <span id="modal-sector-responsible" class="sector-responsible"></span>
            </div>
            <button onclick="closeModal()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;color:var(--text-primary);align-self:flex-start;">&times;</button>
        </div>
        <div style="padding: 15px 20px 0 20px;">
            <input type="text" id="task-search" placeholder="üîç Buscar atividade..." onkeyup="filterTasks()" 
                   style="width:100%; padding:10px; border-radius:8px; border:1px solid #cbd5e1; background:var(--bg-color); color:var(--text-primary); font-family:inherit;">
        </div>
        <div class="modal-content" id="activityList"></div>
        <div class="add-task-container">
            <button id="btn-show-add" class="btn-show-add" onclick="toggleAddForm()">+ Nova Atividade</button>
            <div id="add-task-form">
                <label style="font-size:0.8rem; font-weight:bold; color:#475569">Criar Nova Atividade</label>
                <input type="text" id="new-name" class="edit-input full" placeholder="Nome da atividade...">
                <div class="edit-row">
                    <div style="flex:1">
                        <label style="font-size:0.75rem; display:block; margin-bottom:2px">Data Entrega</label>
                        <input type="date" id="new-date" class="edit-input full">
                    </div>
                </div>
                <input type="text" id="new-note" class="edit-input full" placeholder="Alguma observa√ß√£o?">
                <input type="text" id="new-link" class="edit-input full" placeholder="Cole o Link ou Caminho da pasta...">
                <div class="edit-actions">
                    <button class="btn-action btn-cancel" onclick="toggleAddForm()">Cancelar</button>
                    <button class="btn-action btn-save" onclick="confirmAddTask()">Adicionar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  /* ::::::::::::: LINKS EXTERNOS ::::::::::::: */
  const powerBiUrl = "https://app.powerbi.com/reportEmbed?reportId=7aba2068-f9f4-4c76-9901-1d47614f9922&autoAuth=true&ctid=c760270c-f3da-4cfa-9737-03808ef5579f"; 
  const excelUrl = "https://magna-my.sharepoint.com/personal/rafael_adamo_partner_magna_com/_layouts/15/Doc.aspx?sourcedoc={73c35723-6d28-4759-9a72-4c989de14591}&action=embedview&wdAllowInteractivity=False&wdHideGridlines=True&wdHideHeaders=True&wdDownloadButton=True&wdInConfigurator=True&wdInConfigurator=True";

  const sectorResponsibles = {
      "MONTAGEM": "Haimar Farah & Leo Yamane",
      "INJE√á√ÉO": "Marivaldo & Rubens",
      "MOLDES": "Marivaldo & Rubens",
      "EMBALAGEM": "Paulo Oliveira & Gustavo Alves",
      "METALIZA√á√ÉO": "Fernando Lima",
      "PINTURA": "Fernando Lima"
  };

  const defaultData = {
      "CARBON": { "MONTAGEM": [], "INJE√á√ÉO": [], "MOLDES": [], "EMBALAGEM": [], "METALIZA√á√ÉO": [], "PINTURA": [] },
      "150D": { "MONTAGEM": [], "INJE√á√ÉO": [], "MOLDES": [], "EMBALAGEM": [], "METALIZA√á√ÉO": [], "PINTURA": [] },
      "AFRICA": { "MONTAGEM": [], "INJE√á√ÉO": [], "MOLDES": [], "EMBALAGEM": [], "METALIZA√á√ÉO": [], "PINTURA": [] },
      "history": []
  };
  let projectData = JSON.parse(localStorage.getItem("gestaoVisualData")) || defaultData;
  if(!projectData.history) projectData.history = []; 

  let currentUser = JSON.parse(sessionStorage.getItem("currentUser"));
  let currentProject = "TODOS";
  let selectedSectorIndex = null;
  let editingIndex = null; 

  const sectorNames = ["MONTAGEM", "INJE√á√ÉO", "MOLDES", "EMBALAGEM", "METALIZA√á√ÉO", "PINTURA"];
  const sectorColors = ["#1d4ed8", "#7e22ce", "#ff8c00", "#ffd700", "#b91c1c", "#15803d"];

  if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");
  if(currentUser) initDashboard();

  /* ::::::::::::: FUN√á√ïES GERAIS ::::::::::::: */
  
  function showToast(msg, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      let icon = '‚úÖ';
      let title = 'Sucesso';
      
      if (type === 'warning') { icon = '‚ö†Ô∏è'; title = 'Aten√ß√£o'; }
      if (type === 'error') { icon = '‚ùå'; title = 'Erro'; }
      if (type === 'info') { icon = '‚ÑπÔ∏è'; title = 'Informa√ß√£o'; }

      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
            <span class="toast-title">${title}</span>
            <span class="toast-msg">${msg}</span>
        </div>
      `;
      container.appendChild(toast);
      
      setTimeout(() => { 
          toast.classList.add('hiding'); 
          setTimeout(() => toast.remove(), 300);
      }, 4000);
  }

  function saveData() { 
      localStorage.setItem("gestaoVisualData", JSON.stringify(projectData)); 
      const currentCtx = selectedSectorIndex !== null ? sectorNames[selectedSectorIndex] : null;
      updateDashboardStats(currentCtx);
      desenharEngrenagem();
  }

  function showScreen(screenId) {
      document.querySelectorAll('.auth-form').forEach(el => el.classList.add('hidden-screen'));
      document.getElementById('screen-' + screenId).classList.remove('hidden-screen');
  }

  function login() {
      const u = document.getElementById('login-user').value;
      if(u) {
          currentUser = { name: u };
          sessionStorage.setItem("currentUser", JSON.stringify(currentUser));
          initDashboard();
      }
  }

  function resetPassword() {
      const user = document.getElementById('forgot-user').value;
      const newPass = document.getElementById('forgot-new-pass').value;
      const confirmPass = document.getElementById('forgot-confirm-pass').value;

      if(!user || !newPass || !confirmPass) {
          showToast("Preencha todos os campos para continuar.", "warning");
          return;
      }
      if(newPass !== confirmPass) {
          showToast("As senhas n√£o coincidem!", "error");
          return;
      }

      showToast(`Senha alterada com sucesso para o usu√°rio: ${user}`);
      document.getElementById('forgot-user').value = "";
      document.getElementById('forgot-new-pass').value = "";
      document.getElementById('forgot-confirm-pass').value = "";
      showScreen('login');
  }

  function logout() { sessionStorage.removeItem("currentUser"); location.reload(); }

  function initDashboard() {
      document.body.classList.add('logged-in');
      document.getElementById('main-app').style.display = 'flex';
      document.getElementById('welcome-msg').textContent = `Ol√°, ${currentUser.name.toUpperCase()}`;
      document.querySelector('.avatar-circle').textContent = currentUser.name.substring(0,2).toUpperCase();
      setupProjectSelector();
      updateDashboardStats(); 
      desenharEngrenagem();
  }

  /* ::::::::::::: DASHBOARD LOGIC ::::::::::::: */
  
  function selectSector(i) {
      if (currentProject === "TODOS") {
          showToast("Selecione um projeto espec√≠fico no menu superior para visualizar este setor.", "warning");
          return;
      }

      if(selectedSectorIndex === i) { 
          selectedSectorIndex = null; 
          document.body.classList.remove('view-active'); 
          updateDashboardStats(null); 
          closeModal(); 
      } else { 
          selectedSectorIndex = i; 
          document.body.classList.add('view-active'); 
          updateDashboardStats(sectorNames[i]);
          document.getElementById('details-modal').classList.add('open'); 
          renderTasks(); 
      }
      desenharEngrenagem();
  }

  function closeModal() { 
      document.getElementById('details-modal').classList.remove('open'); 
      document.body.classList.remove('view-active'); 
      selectedSectorIndex = null; 
      updateDashboardStats(null); 
      desenharEngrenagem(); 
  }

  function copyTaskLink(link, name) {
      if(!link) {
          showToast(`Atividade "${name}" sem link configurado.`, "info");
          return;
      }
      navigator.clipboard.writeText(link).then(() => {
          showToast("Link copiado para a √°rea de transfer√™ncia!");
      }).catch(() => showToast("Erro ao copiar link.", "error"));
  }

  function toggleMainMenu() { document.getElementById("main-menu").classList.toggle("show"); }
  function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
      toggleMainMenu();
  }
  
  function addToHistory(action) {
      const log = { action, time: new Date().toLocaleString(), user: currentUser.name };
      projectData.history.unshift(log);
      if(projectData.history.length > 50) projectData.history.pop(); 
  }
  
  function toggleHistory() {
      const el = document.getElementById("history-overlay");
      const list = document.getElementById("history-content");
      if(el.style.display === "flex") {
          el.style.display = "none";
      } else {
          el.style.display = "flex";
          document.getElementById("main-menu").classList.remove("show"); 
          list.innerHTML = "";
          if(projectData.history.length === 0) {
              list.innerHTML = '<div class="empty-hist">Nenhum registro recente.</div>';
          } else {
              projectData.history.forEach(h => {
                  list.innerHTML += `<div class="hist-item"><strong>${h.user}</strong>: ${h.action} <span class="hist-time">${h.time}</span></div>`;
              });
          }
      }
  }
  function clearHistory() { projectData.history = []; saveData(); toggleHistory(); }

  function updateDashboardStats(specificSector = null) {
      const titleEl = document.querySelector('.card-header h3');
      let finalAvg = 0;
      let totalCritical = 0;
      let minDate = null;
      const today = new Date().toISOString().split('T')[0];

      if (currentProject === "TODOS" && !specificSector) {
          titleEl.textContent = "Vis√£o Geral (Todos)";
          titleEl.style.color = "var(--text-primary)";
          let sumOfProjectAvgs = 0;
          let projectsCount = 0;
          Object.keys(projectData).forEach(projKey => {
              if (projKey !== 'history') {
                  projectsCount++;
                  const sectors = projectData[projKey];
                  let pTasks = 0;
                  let pProgressSum = 0;
                  Object.values(sectors).forEach(list => {
                      list.forEach(t => {
                          pTasks++;
                          pProgressSum += (t.progress || 0);
                          if(t.deadline && t.deadline < today && t.progress < 100) totalCritical++;
                          if(t.deadline && t.progress < 100) { if(!minDate || t.deadline < minDate) minDate = t.deadline; }
                      });
                  });
                  const projAvg = pTasks > 0 ? (pProgressSum / pTasks) : 0;
                  sumOfProjectAvgs += projAvg;
              }
          });
          finalAvg = projectsCount > 0 ? Math.round(sumOfProjectAvgs / projectsCount) : 0;
      } 
      else {
          const targetProj = projectData[currentProject] || {};
          let tasksToAnalyze = [];
          if (specificSector) {
              tasksToAnalyze = targetProj[specificSector] || [];
              titleEl.textContent = `Vis√£o: ${specificSector}`;
              titleEl.style.color = "var(--primary-blue)";
          } else {
              titleEl.textContent = `Vis√£o Geral: ${currentProject}`;
              titleEl.style.color = "var(--text-primary)";
              Object.values(targetProj).forEach(t => tasksToAnalyze = tasksToAnalyze.concat(t));
          }
          let pTasks = 0;
          let pSum = 0;
          tasksToAnalyze.forEach(task => {
              pTasks++;
              pSum += (task.progress || 0);
              if(task.deadline && task.deadline < today && task.progress < 100) totalCritical++;
              if(task.deadline && task.progress < 100) { if(!minDate || task.deadline < minDate) minDate = task.deadline; }
          });
          finalAvg = pTasks > 0 ? Math.round(pSum / pTasks) : 0;
      }
      
      document.getElementById('card-total-percent').textContent = `${finalAvg}%`;
      const donutFill = document.getElementById('donut-fill');
      setTimeout(() => { if(donutFill) donutFill.style.strokeDasharray = `${finalAvg}, 100`; }, 50);
      const strokeColor = finalAvg < 30 ? 'var(--danger-color)' : finalAvg < 70 ? 'var(--warning-color)' : 'var(--success-color)';
      if(donutFill) donutFill.style.stroke = strokeColor;
      document.getElementById('card-critical-count').textContent = totalCritical;
      if(minDate) {
          const [y, m, d] = minDate.split('-');
          document.getElementById('card-next-date').textContent = `${d}/${m}`;
      } else {
          document.getElementById('card-next-date').textContent = "--/--";
      }
  }

  const svgNS = "http://www.w3.org/2000/svg";
  function desenharEngrenagem() {
      const gearSVG = document.getElementById("gearSVG");
      if(!gearSVG) return;
      gearSVG.innerHTML = "";
      const defs = document.createElementNS(svgNS, "defs");
      let filters = `
        <linearGradient id="silverBody" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#cbd5e1" /><stop offset="50%" stop-color="#f8fafc" /><stop offset="100%" stop-color="#94a3b8" />
        </linearGradient>
        <filter id="bevelLight" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
            <feSpecularLighting in="blur" surfaceScale="3" specularConstant="1.5" specularExponent="40" lighting-color="#ffffff" result="specOut"><fePointLight x="-5000" y="-10000" z="20000"/></feSpecularLighting>
            <feComposite in="specOut" in2="SourceAlpha" operator="in" result="specOut"/>
            <feComposite in="SourceGraphic" in2="specOut" operator="arithmetic" k1="0" k2="1" k3="1" k4="0"/>
        </filter>
        <filter id="hubShadow">
             <feOffset dx="0" dy="0"/> <feGaussianBlur stdDeviation="5" result="offset-blur"/>
             <feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse"/>
             <feFlood flood-color="#334155" flood-opacity="0.4" result="color"/>
             <feComposite operator="in" in="color" in2="inverse" result="shadow"/>
             <feComposite operator="over" in="shadow" in2="SourceGraphic"/>
        </filter>
      `;
      sectorColors.forEach((c, i) => {
          filters += `
            <linearGradient id="sec-grad-${i}" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="${c}" /><stop offset="50%" stop-color="${adjustBrightness(c, 20)}" /><stop offset="100%" stop-color="${c}" />
            </linearGradient>
            <linearGradient id="gloss-${i}" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="white" stop-opacity="0.15"/><stop offset="40%" stop-color="white" stop-opacity="0"/><stop offset="100%" stop-color="white" stop-opacity="0"/>
            </linearGradient>
          `;
      });
      defs.innerHTML = filters;
      gearSVG.appendChild(defs);

      const g = document.createElementNS(svgNS, "g");
      g.setAttribute("class", "gear-spin"); 
      if(selectedSectorIndex !== null) { g.classList.add("paused"); }

      const gearBody = document.createElementNS(svgNS, "path");
      gearBody.setAttribute("d", createGearPath(250, 250, 245, 215, 8)); 
      gearBody.setAttribute("fill", "url(#silverBody)");
      gearBody.setAttribute("stroke", "#ffffff"); 
      gearBody.setAttribute("stroke-width", "1");
      gearBody.setAttribute("filter", "url(#bevelLight)");
      g.appendChild(gearBody);

      const ring = document.createElementNS(svgNS, "circle");
      ring.setAttribute("cx", 250); ring.setAttribute("cy", 250); ring.setAttribute("r", 208);
      ring.setAttribute("fill", "none"); ring.setAttribute("stroke", "#cbd5e1"); ring.setAttribute("stroke-width", "1");
      g.appendChild(ring);

      const sectorGroup = document.createElementNS(svgNS, "g");
      const angle = 360 / sectorNames.length;
      sectorGroup.setAttribute("transform", "rotate(-90 250 250)");

      for(let i=0; i<sectorNames.length; i++) {
          const s = i * angle, e = s + angle;
          const grp = document.createElementNS(svgNS, "g");
          grp.setAttribute("class", selectedSectorIndex===i ? "sector-group sector-selected" : "sector-group");
          grp.onclick = () => selectSector(i);
          grp.onmouseenter = (ev) => showTooltip(ev, sectorNames[i]);
          grp.onmousemove = moveTooltip;
          grp.onmouseleave = hideTooltip;

          const p = document.createElementNS(svgNS, "path");
          p.setAttribute("d", createArcPath(250,250,205,90,s,e));
          p.setAttribute("fill", `url(#sec-grad-${i})`);
          const gloss = document.createElementNS(svgNS, "path");
          gloss.setAttribute("d", createArcPath(250,250,205,90,s,e));
          gloss.setAttribute("fill", `url(#gloss-${i})`);
          gloss.setAttribute("style", "pointer-events:none;");
          grp.appendChild(p); grp.appendChild(gloss);
          
          const m = (s+e)/2, tr = 148;
          const tx = 250 + tr * Math.cos(m * Math.PI/180);
          const ty = 250 + tr * Math.sin(m * Math.PI/180);
          const t = document.createElementNS(svgNS, "text");
          t.textContent = sectorNames[i];
          t.setAttribute("x", tx); t.setAttribute("y", ty);
          t.setAttribute("transform", `rotate(${m+90} ${tx} ${ty})`);
          t.setAttribute("fill", "#0f172a"); 
          t.setAttribute("style", "font-size:13px; font-weight:800; text-anchor:middle; pointer-events:none; filter:drop-shadow(0 1px 0 rgba(255,255,255,0.4))");
          
          grp.appendChild(t);
          sectorGroup.appendChild(grp);
      }
      g.appendChild(sectorGroup);

      const hub = document.createElementNS(svgNS, "circle");
      hub.setAttribute("cx", 250); hub.setAttribute("cy", 250); hub.setAttribute("r", 85);
      hub.setAttribute("fill", "#e2e8f0"); 
      hub.setAttribute("stroke", "#94a3b8"); 
      hub.setAttribute("stroke-width", "4");
      hub.setAttribute("filter", "url(#hubShadow)");
      g.appendChild(hub);

      gearSVG.appendChild(g);
  }

  function createGearPath(cx, cy, rOuter, rInner, teeth) {
      let d = "";
      const step = (Math.PI * 2) / teeth;
      const tWidth = step * 0.6; 
      for(let i=0; i<teeth; i++) {
          const theta = i * step;
          const b1x = cx + rInner * Math.cos(theta);
          const b1y = cy + rInner * Math.sin(theta);
          const p1x = cx + rOuter * Math.cos(theta + tWidth*0.1); 
          const p1y = cy + rOuter * Math.sin(theta + tWidth*0.1);
          const p2x = cx + rOuter * Math.cos(theta + tWidth*0.9);
          const p2y = cy + rOuter * Math.sin(theta + tWidth*0.9);
          const b2x = cx + rInner * Math.cos(theta + tWidth);
          const b2y = cy + rInner * Math.sin(theta + tWidth);
          const nextBx = cx + rInner * Math.cos(theta + step);
          const nextBy = cy + rInner * Math.sin(theta + step);
          if(i===0) d += `M ${b1x} ${b1y}`;
          d += ` L ${p1x} ${p1y}`; d += ` A ${rOuter} ${rOuter} 0 0 1 ${p2x} ${p2y}`; d += ` L ${b2x} ${b2y}`; d += ` A ${rInner} ${rInner} 0 0 0 ${nextBx} ${nextBy}`;
      }
      d += " Z"; return d;
  }

  function createArcPath(cx, cy, rOut, rIn, s, e) {
      const r = Math.PI/180;
      const x1 = cx+rIn*Math.cos(s*r), y1 = cy+rIn*Math.sin(s*r);
      const x2 = cx+rOut*Math.cos(s*r), y2 = cy+rOut*Math.sin(s*r);
      const x3 = cx+rOut*Math.cos(e*r), y3 = cy+rOut*Math.sin(e*r);
      const x4 = cx+rIn*Math.cos(e*r), y4 = cy+rIn*Math.sin(e*r);
      return `M ${x1} ${y1} L ${x2} ${y2} A ${rOut} ${rOut} 0 0 1 ${x3} ${y3} L ${x4} ${y4} A ${rIn} ${rIn} 0 0 0 ${x1} ${y1} Z`;
  }
  function adjustBrightness(h, p) {
      let n=parseInt(h.replace("#",""),16),a=Math.round(2.55*p),R=(n>>16)+a,B=(n>>8&0xFF)+a,G=(n&0xFF)+a;
      return "#"+(0x1000000+(R<255?R<1?0:R:255)*0x10000+(B<255?B<1?0:B:255)*0x100+(G<255?G<1?0:G:255)).toString(16).slice(1);
  }

  function filterTasks() {
      const term = document.getElementById('task-search').value.toLowerCase();
      const tasks = document.querySelectorAll('.task-item');
      tasks.forEach(task => {
          const text = task.querySelector('.task-title').innerText.toLowerCase();
          task.style.display = text.includes(term) ? 'flex' : 'none';
      });
  }

  function renderTasks() {
      const searchInput = document.getElementById('task-search');
      if(searchInput) searchInput.value = '';
      if(selectedSectorIndex === null) return;
      const sName = sectorNames[selectedSectorIndex];
      document.getElementById('modal-sector-title').textContent = sName;
      document.getElementById('modal-sector-responsible').textContent = `Respons√°vel: ${sectorResponsibles[sName] || "N/A"}`;
      const list = projectData[currentProject]?.[sName] || [];
      const c = document.getElementById("activityList"); c.innerHTML = "";

      list.forEach((t, idx) => {
          if (editingIndex === idx) {
              const editCard = document.createElement('div');
              editCard.className = 'task-edit-card';
              editCard.innerHTML = `
                  <input type="text" id="edit-name" class="edit-input full" value="${t.name}">
                  <div class="edit-row">
                      <select id="edit-progress" class="edit-input full">
                          <option value="0" ${t.progress===0?'selected':''}>0%</option>
                          <option value="25" ${t.progress===25?'selected':''}>25%</option>
                          <option value="50" ${t.progress===50?'selected':''}>50%</option>
                          <option value="75" ${t.progress===75?'selected':''}>75%</option>
                          <option value="100" ${t.progress===100?'selected':''}>100%</option>
                      </select>
                      <input type="date" id="edit-date" class="edit-input full" value="${t.deadline||''}">
                  </div>
                  <input type="text" id="edit-link" class="edit-input full" value="${t.link||''}" placeholder="Link / Caminho...">
                  <div class="edit-actions">
                      <button class="btn-action btn-delete" onclick="deleteTask(${idx})">Excluir</button>
                      <button class="btn-action btn-save" onclick="saveTask(${idx})">Salvar</button>
                  </div>`;
              c.appendChild(editCard);
          } else {
              const color = t.progress===100?'var(--success-color)':t.progress===0?'#cbd5e1':'var(--primary-blue)';
              const row = document.createElement('div');
              row.className = 'task-item';
              row.onclick = (e) => { if(!e.target.closest('button')) copyTaskLink(t.link, t.name); };
              row.innerHTML = `
                  <div class="task-status-bar" style="background:${color}"></div>
                  <div class="task-info">
                      <div class="task-title">${t.name} ${t.link?'üîó':''}</div>
                      <div class="task-meta"><span style="color:${color}">${t.progress}%</span></div>
                  </div>
                  <button onclick="enableEdit(${idx})" class="btn-icon-edit">‚úé</button>`;
              c.appendChild(row);
          }
      });
  }

  function enableEdit(idx) { editingIndex = idx; renderTasks(); }
  function saveTask(idx) {
      const s = sectorNames[selectedSectorIndex];
      projectData[currentProject][s][idx].name = document.getElementById('edit-name').value;
      projectData[currentProject][s][idx].progress = parseInt(document.getElementById('edit-progress').value);
      projectData[currentProject][s][idx].deadline = document.getElementById('edit-date').value;
      projectData[currentProject][s][idx].link = document.getElementById('edit-link').value;
      if(projectData[currentProject][s][idx].progress === 100) confetti({ origin:{x:1, y:0.5} });
      editingIndex = null; saveData(); renderTasks();
  }

  function deleteTask(ix) {
      if(confirm("Excluir atividade?")) { 
          projectData[currentProject][sectorNames[selectedSectorIndex]].splice(ix,1); 
          editingIndex=null; saveData(); renderTasks(); 
      }
  }

  function confirmAddTask() {
      const name = document.getElementById("new-name").value;
      if(!name) return;
      const s = sectorNames[selectedSectorIndex];
      if (!projectData[currentProject][s]) projectData[currentProject][s] = [];
      projectData[currentProject][s].push({ name, progress: 0, deadline: document.getElementById("new-date").value, link: document.getElementById("new-link").value });
      saveData(); renderTasks(); toggleAddForm();
  }

  function toggleAddForm() {
      const form = document.getElementById('add-task-form');
      form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
  }

  function setupProjectSelector() {
      const drop = document.getElementById('projectDropdown');
      document.getElementById('projectButton').onclick = (e) => { e.stopPropagation(); drop.classList.toggle('show'); };
      drop.innerHTML = '<button class="btn-all-projects" onclick="selectProj(\'TODOS\', \'Todos\')">Todos</button>';
      Object.keys(projectData).forEach(k => {
          if(k !== 'history' && k !== 'TODOS') {
              const b = document.createElement("button"); b.textContent = k;
              b.onclick = () => selectProj(k, k);
              drop.appendChild(b);
          }
      });
  }
  function selectProj(id, txt) {
      currentProject = id; document.getElementById('currentProjectText').textContent = txt;
      document.getElementById('projectDropdown').classList.remove('show');
      closeModal(); updateDashboardStats(); desenharEngrenagem();
  }
  
  const tt = document.getElementById('gear-tooltip');
  function showTooltip(e,t){ tt.style.display='block'; tt.textContent=t; moveTooltip(e); }
  function moveTooltip(e){ tt.style.left=(e.clientX+15)+'px'; tt.style.top=(e.clientY+15)+'px'; }
  function hideTooltip(){ tt.style.display='none'; }
  
  /* ::::::::::::: CORRE√á√ÉO DAS FUN√á√ïES POWER BI E EXCEL ::::::::::::: */
  
  function togglePowerBI() { 
      const overlay = document.getElementById('powerbi-overlay');
      const iframe = document.getElementById('pbi-iframe');
      
      if (overlay.style.display === 'flex') {
          overlay.style.display = 'none';
      } else {
          overlay.style.display = 'flex';
          // Carrega o link apenas se ainda n√£o estiver carregado para evitar recarregar √† toa
          if (!iframe.src || iframe.src === window.location.href) {
              iframe.src = powerBiUrl;
          }
          document.getElementById("main-menu").classList.remove("show");
      }
  }

  function toggleExcel() { 
      const overlay = document.getElementById('excel-overlay');
      const iframe = document.getElementById('excel-iframe');
      
      if (overlay.style.display === 'flex') {
          overlay.style.display = 'none';
      } else {
          overlay.style.display = 'flex';
          // Carrega o link apenas se ainda n√£o estiver carregado
          if (!iframe.src || iframe.src === window.location.href) {
              iframe.src = excelUrl;
          }
          document.getElementById("main-menu").classList.remove("show");
      }
  }

</script>
</body>
</html>